<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>紙の一覧</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div th:insert="~{fragments.html :: header}"></div>

<h2>紙の一覧</h2>

<!-- 検索フォーム -->
<form th:action="@{/paper/search}" method="get">
    <div>
        <label for="paperName">紙の名前　</label>
        <input type="text" id="paperName" name="paperName" th:value="${param.paperName}">
    </div>
    <div>
        <label for="typeName">種類　</label>
        <input type="text" id="typeName" name="typeName" th:value="${param.typeName}">
    </div>
    <div style="max-width: 500px;">
        <label>タグ（複数選択可）　</label>
        <div th:each="tag : ${allTags}" class="tag-checkbox-label">
            <label>
                <input type="checkbox" name="tagNames" th:value="${tag.tagName}"
                       th:checked="${param.tagNames != null and (#lists.contains(param.tagNames, tag.tagName) or param.tagNames == tag.tagName)}">
                <span th:text="${tag.tagName}"></span>
            </label>
        </div>
    </div>


    <div class="search-button-container">
        <button type="submit">検索</button>
    </div>
</form>


<!-- 検索結果のメッセージ -->
<div th:if="${message != null}" class="search-result-message">
    <p th:text="${message}"></p>
</div>

<table>
    <thead>
    <tr>
        <th>紙の名前</th>
        <th>種類</th>
        <th>説明</th>
        <th>タグ</th>
        <th>お気に入り</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="paper : ${papers}">
        <td th:text="${paper.paperName}"></td>
        <td th:text="${paper.typeName}"></td>
        <td th:text="${paper.description}"></td>
        <td>
            <span th:each="tag : ${paper.tagNamesList}" th:text="${tag}" class="tag-label"></span>
        </td>
        <td>
            <button th:id="'fav-btn-' + ${paper.paperId}"
                    th:data-paper-id="${paper.paperId}"
                    th:data-favorite="${paper.favorite}"
                    th:text="${paper.favorite} ? 'ー 削除' : '＋ 追加'"
                    th:class="${paper.favorite} ? 'fav-remove' : 'fav-add'"
                    onclick="toggleFavorite(this)">
            </button>
        </td>

        </td>
    </tr>
    </tbody>
</table>

<script>
    function toggleFavorite(button) {
    const paperId = button.getAttribute("data-paper-id");

    fetch("/paper/toggleFavorite", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `paperId=${paperId}`
    }).then(response => response.text())
      .then(result => {
          if (result === "ADDED") {
              button.textContent = "ー 削除";
              button.setAttribute("data-favorite", "true");
              button.className = "fav-remove";
          } else if (result === "DELETED") {
              button.textContent = "＋ 追加";
              button.setAttribute("data-favorite", "false");
              button.className = "fav-add";
          }
      }).catch(error => {
          console.error("エラー:", error);
          alert("通信エラーが発生しました");
      });
}
</script>


<div th:insert="~{fragments.html :: footer}"></div>
</body>
</html>
